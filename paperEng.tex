\documentclass[11pt]{article}
\usepackage[a4paper,top=2cm,bottom=2cm,left=1.5cm,right=1.5cm]{geometry}
\usepackage{graphicx}
\usepackage[linesnumbered,ruled,noend]{algorithm2e}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
%\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{amssymb}
%\usepackage{xltxtra}
%\usepackage{xunicode}
%\usepackage{color}
%\usepackage[table]{xcolor}
\usepackage{fancyvrb}
%\usepackage{enumitem}
%\usepackage{framed}
%\usepackage{relsize}
%\usepackage{float}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{hyperref}
\usepackage{courier}
\usepackage{listings}

\newtheorem{theorem}{Theorem}[section]
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\theoremstyle{corollary}
\newtheorem{corollary}{Corollary}[section]

\lstset{frame=tb,
%  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

% PDF bookmarks
\usepackage{color,hyperref}
\definecolor{darkblue}{rgb}{0.0,0.0,0.3}
\hypersetup{colorlinks,breaklinks,
    linkcolor=darkblue,urlcolor=darkblue,
    anchorcolor=darkblue,citecolor=darkblue}

\pagestyle{fancy}{ %
    \fancyhf{} % remove everything
        \renewcommand{\headrulewidth}{0pt} % remove lines as well
        \renewcommand{\footrulewidth}{0.5pt}
        \rhead{\leftmark}
        \lhead{Decentralized financial reputation with multisig for lines-of-credit}
        \rfoot{Page \thepage\ of \pageref{LastPage}}}
        
\begin{document}

  \section{Abstract}
      We propose a decentralized reputation system that can replace the word-of-mouth, stars- and review-based systems.
      The basic idea is that a member A trusts her friends with a certain value (with a 1/2 multisig), thus
      risking to lose their value. When A wants to transfer value V to a (maybe previously unknown) member B,
      A asks the system if she trusts B enough to transfer this value to B. The system will search throughout
      the network for trust paths that begin from A and reach B and add up to V and will answer whether the
      proposed transaction is within the trust capabilities of A towards B. If the answer is positive, it means
      that transferring value V to B will not raise the risk for A to lose their value.
      Note: we use Bitcoin terminology.

  \section{Introduction}

  \section{Tags/Keywords}
      decentralized, trust, web-of-trust, bitcoin, multisig, line-of-credit, trust-as-risk, flow  

  \section{Related Work}

  \section{Key points}

  \section{Definitions}
      \begin{definition}[Direct Trust from A to B, $DTr_{A \rightarrow B}$] \ \\
         Total amount of value that exists in 1/\{A,B\} multisigs in the utxo, where the money is deposited by A.
      \end{definition}
      \begin{definition}[B steals $x$ from A] \ \\
         B steals value $x$ from A when B reduces the $DTr_{A \rightarrow B}$ by $x$. This makes sense when 
         $x \leq DTr_{A \rightarrow B}$.
      \end{definition}
      \begin{definition}[Honest strategy] \ \\
         A member A is said to follow the honest strategy if for any value $x$ that is stolen from her, she
         substitutes it by stealing from others that trust her value equal to
         $min(x,\sum_{B \in members}{DTr_{B \rightarrow A}})$ and she takes no other action.
      \end{definition}
      \begin{definition}[Indirect trust from A to B $Tr_{A \rightarrow B}$] \ \\
         Value that A will lose if B steals the maximum amount she can steal (all her incoming trust) and everyone
         else follows the honest strategy.
      \end{definition}
  \section{Theorems-Algorithms}
    \begin{theorem}
    $Tr_{A \rightarrow B} = MaxFlow_{A \rightarrow B}$ (Treating trusts as capacities)
    \end{theorem}
    \begin{proof} \ 
        \begin{enumerate}
           \item $Tr_{A \rightarrow B} \geq MaxFlow_{A \rightarrow B}$ because by the definition of $Tr_{A \rightarrow B}$,
           B leaves taking with him all the incoming trust, so there is no trust flowing towards him after leaving.
           $Tr_{A \rightarrow B} < MaxFlow_{A \rightarrow B}$ would imply that after B left, there would still remain trust
           flowing from A to B.
           \item $Tr_{A \rightarrow B} \leq MaxFlow_{A \rightarrow B}$ \\
           Suppose that $Tr_{A \rightarrow B} > MaxFlow_{A \rightarrow B}$ (1). Then, using the min cut - max flow theorem we
           see that there is a set of capacities $C= \{c_1,...,c_n\}$ with flows $X = \{x_1,...,x_n\}$ such that
           $\sum_{i=1}^{n}{x_i} = MaxFlow_{A \rightarrow B}$ and, if severed $(c_i' = 0\:\forall i \in \{1,...,n\})$ the flow
           from A to B would be $0$, or, put differently, there would be no directed trust path from A to B. No strategy
           followed by B could reduce the value of A, so our supposition (1) cannot be true.
        \end{enumerate}
        Combining the two results, we see that $Tr_{A \rightarrow B} = MaxFlow_{A \rightarrow B}$.
    \end{proof}

    \begin{theorem}
       If everybody follows the honest strategy, nobody steals any amount from anybody.
    \end{theorem}
    \begin{proof}
       According to the definition of the honest strategy, a member steals a value only when he is stolen at least the same value.
       Let A be a member of the network. Suppose that A steals value V from member B. Since A follows the honest strategy, she has
       been stolen at least V from another member, C. The same argument holds for C. This reasoning cannot be repeated
       \textit{ad infinitum} because the network has finite members and finite total value. Thus member A could not have stolen any value.
    \end{proof}
    \begin{theorem}[Trust transfer theorem (flow terminology)] \ \\
    \label{trusttransfer}
       Let $s$ source, $t$ sink, \\
       $X_s = \{x_{s, 1}, ..., x_{s, n}\}$ outgoing flows from $s$, \\
       $X_t = \{x_{1, t}, ..., x_{m, t}\}$ incoming flows to $t$, \\
       $U_s = \{u_{s, 1}, ..., u_{s, n}\}$ outgoing capacities from $s$, \\
       $U_t = \{u_{1, t}, ..., u_{m, t}\}$ incoming capacities to $t$, \\
       $V$ the value to be transferred. \\
       Nodes apart from $s$, $t$ cannot create or consume flow. \\
       Obviously $maxFlow = F = \sum_{i=1}^{n}{x_{t \rightarrow i}}$.
       {\em \begin{lstlisting}
            /                      ....                     \
           / x_s1/u_s1                         x_1t/u_1t     \
          /                                                   \
         /                                                     \
        / x_s2/u_s2                               x_2t/u_2t     \
       s-------------              ....          ------------t
        \      .                                           .    /
         \     .                                           .   /
          \    .                                           .  /
           \ x_sn/u_sn             ....        x_mt/u_mt     /
            \                                               /
       \end{lstlisting}}
       We create a new graph where
       \begin{enumerate}
         \item  $\sum_{i}{u_{s, i}'} = F - V$
         \item $u_{s, i}' \leq x_{s, i} \forall i \in \{1,...,n\}$
       \end{enumerate}
 
       It holds that $maxFlow' = F' = F - V$.
    \end{theorem}
    \begin{proof} \
       \begin{enumerate}
         \item  It is impossible to have $F' > F - V$ because $F' \leq \sum{u_{s, i}'} = F - V$.
         \item  It is impossible to have $F' < F - V$. \\
         Let $i$ be a node such that $x_{s, i} > 0$ and $I = \{(i,j) \in E\}$ the set of direct trusts outgoing from $i$.
         In the initial graph we have $x_{s, i} = \sum_{j}{x_{i, j}}, F = \sum_{i}{x_{s, i}}$
         and in the new graph we have $x_{s, i}' = u_{s, i}' \leq x_{s, i},
         F' = \sum_{i}{x_{s, i}'}, x_{i, j} \leq u_{i, j} = u_{i, j}' \:\forall\: j, i$.
         We can construct a set $X_i' = \{x_{i, j}'\}$ of flows such that $x_{i, j}' \leq x_{i, j}$
         and $\sum_{j}{x_{i, j}'} = x_{s, i}'$. This shows that there is a possible flow such that $F' = F - V$,
         so the maxFlow algorithm will not return a flow less than $F - V$. \\
         Example construction: \\
         $x_{i, j}' = x_{i, j} \:\forall \:j \in \{1,...,k\}$ with $k$ such that
            \begin{enumerate}
	      \item $\sum_{j=1}^{k}{x_{i, j}} \leq x_{s, i}'$ and
	      \item $\sum_{j=1}^{k+1}{x_{i, j}} > x_{s, i}'$
            \end{enumerate}
         $x_{i, (k+1)}' = x_{s, i}' - \sum_{j=1}^{k}{x_{i, j}'}$ \\
         $x_{i, j}' = 0 \:\forall \:j \in \{k+2,...,|X_i'|\}$
       \end{enumerate}
    \end{proof}

    \begin{corollary}[Requirement for $\sum_{i}{u_{s, i}'} = F - V$, $u_{s, i}' \leq x_{s, i}$] \ \\
       In the setting of \ref{trusttransfer}, it is impossible to have $maxFlow' = F - V$ if $\sum_{i}{u_{s, i}'} > F - V
       \wedge u_{s, i}' \leq x_{s, i}\: \forall \:i \in \{1,...,n\}$.
    \end{corollary}
    \begin{proof}
       Due to \ref{trusttransfer}, $maxFlow' = F - V$ if $\sum_{i}{u_{s, i}'} = F - V
       \wedge u_{s, i}' \leq x_{s, i}\: \forall \:i \in \{1,...,n\}$. If we create new capacities such that
       $u_{s,i}'' \leq x_{s,i}\:\forall\:i \in \{1,...,n\}$, then obviously $maxFlow'' = \sum_{i}{u_{s,i}''}$. If
       additionally $\sum_{i}{u_{s,i}''} > F - V$, then $maxFlow'' > F - V$.
    \end{proof}

    \begin{theorem}[Trust-saving Theorem] \ \\
       $u_i' = F_{A_i \rightarrow B} \Leftrightarrow u_i' = u_i \: \forall \: i$
    \end{theorem}
    \begin{proof}
       We know that $x_i \leq F_{A_i \rightarrow B}$, thus we can see that any increase in $u_i'$ beyond
       $F_{A_i \rightarrow B}$ will not influence $x_i$ and subsequently will not incur any change on the rest of the flows.
    \end{proof}

    \begin{theorem}[Invariable trust reduction with naive algorithms] \ \\
       If $u_i' \leq x_i \: \forall \: i$, Trust Reduction (TrR) invariable $\: \forall \:$ configurations of $x_i$
    \end{theorem}
    \begin{proof}
       $TrR = \sum_{i=1}^{n}TrR_i$ total Trust Reduction, $TrR_i = u_i - u_i'$, Trust Reduction on i.
       Since $u_i' \leq x_i \: \forall \: i$ it is $x_i' = u_i'$, thus $TrR_i = u_i - x_i'$. We know that
       $\sum_{i=1}^{n}x_i' = F - V$, so we have $TrR = \sum_{i=1}^{n}TrR_i = \sum_{i=1}^{n}(u_i - x_i') = 
       \sum_{i=1}^{n}u_i - F + V$ independent of $x_i', u_i'$
    \end{proof}

    \begin{theorem}[Dependence impossibility theorem] \ \\
       ${d x_j \over d x_i} = 0$ with $x_i$ the flow from MaxFlow $\Rightarrow {d x_j \over d x_i} = 0 \:
       \forall \: x_i' < x_i$ ceteris paribus
    \end{theorem}
    \begin{proof}
       TODO
    \end{proof}

    Here we show three naive algorithms for calculating new direct trusts so as to maintain invariable risk when paying
    a trusted party. \\
    \begin{algorithm}[H]
       \SetKwInOut{Input}{Input}
       \SetKwInOut{Output}{Output}
       \Input{$x_i$ flows, $n$ flows number, $V$ value}
       \Output{$u_i'$ capacities}
       $F \gets \sum_{i=1}^{n}x_i$ \\
       \If{$F < V$}{\Return error}
       $Fcur \gets F$ \\
       \For{$i \gets 1$ to $n$}
          {$u_i' \gets x_i$} 
       $i \gets 1$ \\
       \While{$Fcur > F - V$}
          {$reduce \gets min(u_i', Fcur - V)$ \\
           $Fcur \gets Fcur - reduce$ \\
           $u_i' \gets u_i' - reduce$ \\
           $i \gets i + 1$}
       \caption{First-come, first-served trust transfer}
    \end{algorithm}

    \begin{algorithm}[H]
       \SetKwInOut{Input}{Input}
       \SetKwInOut{Output}{Output}
       \Input{$x_i$ flows, $n$ flows number, $V$ value}
       \Output{$u_i'$ capacities}
       $F \gets \sum_{i=1}^{n}x_i$ \\
       \If{$F < V$}{\Return error}
       \For{$i \gets 1$ to $n$}
          {$u_i' \gets x_i$}
       $reduce \gets {V \over n}$ \\
       $reduction \gets 0$ \\
       $empty \gets 0$ \\
       $i \gets 0$ \\
       \While{$reduction < V$}
          {\If{$u_i' > 0 \:AND \:x_i < reduce$}
                {$empty \gets empty + 1$ \\
                 $reduce = reduce + {{u_i'} \over {n - empty}}$ \\
                 $reduction \gets reduction + u_i'$ \\
                 $u_i' \gets 0$ \\}
           \ElseIf{$x_i \geq reduce$}{$reduction \gets reduction + u_i' - (x_i - reduce)$ \\
                 $u_i' \gets x_i - reduce$}
           $i \gets (i + 1) mod \:n$}
       \caption{Absolute equality trust transfer}
    \end{algorithm}

    \begin{algorithm}[H]
       \SetKwInOut{Input}{Input}
       \SetKwInOut{Output}{Output}
       \Input{$x_i$ flows, $n$ flows number, $V$ value}
       \Output{$u_i'$ capacities}
       $F \gets \sum_{i=1}^{n}x_i$ \\
       \If{$F < V$}{\Return error}
       \For{$i \gets 1$ to $n$}
          {$u_i' \gets x_i - {{F - V} \over {\sum_{i=1}^{n}x_i}} \cdot x_i$}
       \caption{Proportional equality trust transfer}
    \end{algorithm}
    \begin{proof}[Proof of correctness]
       In all three algorithms, we have $u_i' <= x_i$ because in the only case where $u_i'$ is altered after its
       initialisation, it is reduced. Furthermore, a total of $V$ is subtracted from all the $u_i'$, thus
       $\sum_{i=1}^{n}u_i' = F - V$.
    \end{proof}

    However, we need to minimize $\sum_{i=1}^{n}(u_i-u_i')$.

  \section{Further Research}

  \section{References}

\end{document}
